<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHIZ-MD QR Code</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="whizmd.png" type="image/png">
</head>
<body>
    <div class="container">
        <div class="qr-card">
            <img src="whizmd.png" alt="WHIZ-MD Logo" class="brand-logo-header">
            <h1>Scan to Link with WHIZ-MD</h1>
            <div class="qr-code-container">
                <!-- QR code will be dynamically inserted here -->
                <img id="qrImage" src="" alt="WhatsApp QR Code">
            </div>
            <p>Scan this QR code with WhatsApp (Linked Devices > Link a device).</p>
            <div class="timer">
                <p>QR code refreshes in: <span id="countdown">60</span>s</p>
            </div>
            <p class="status-message" id="statusMessage"></p>
        </div>
    </div>

    <script>
        const qrImage = document.getElementById('qrImage');
        const countdownElement = document.getElementById('countdown');
        const statusMessageElement = document.getElementById('statusMessage');
        let countdownInterval;

        async function fetchQRCode() {
            try {
                statusMessageElement.textContent = 'Fetching QR code...';
                qrImage.src = ''; // Clear previous QR

                const response = await fetch('/api/get-qr-code');
                const data = await response.json();

                if (response.status === 500) {
                    throw new Error(data.message || 'Server error fetching QR code.');
                }

                if (data.status === 'success' && data.qrDataURL) {
                    qrImage.src = data.qrDataURL;
                    statusMessageElement.textContent = 'QR code loaded. Please scan.';
                    startCountdown(60); // Start countdown for refresh
                } else if (data.status === 'connecting') {
                    statusMessageElement.textContent = data.message;
                    qrImage.src = 'https://via.placeholder.com/250/0000FF/FFFFFF/?text=Connecting...';
                    setTimeout(fetchQRCode, 5000); // Retry after 5 seconds if still connecting
                } else if (data.status === 'pending') {
                    statusMessageElement.textContent = data.message;
                    qrImage.src = 'https://via.placeholder.com/250/FFA500/000000/?text=Waiting...';
                    setTimeout(fetchQRCode, 3000); // Retry after 3 seconds if pending
                } else if (data.status === 'connected') {
                    statusMessageElement.textContent = data.message;
                    qrImage.src = 'https://via.placeholder.com/250/008000/FFFFFF/?text=Connected!';
                    clearInterval(countdownInterval);
                    countdownElement.textContent = 'N/A';
                } else {
                     throw new Error(data.message || 'Unknown status fetching QR code.');
                }
            } catch (error) {
                console.error('Error fetching QR code:', error);
                statusMessageElement.textContent = error.message || 'Error loading QR code. Please refresh.';
                qrImage.src = 'https://via.placeholder.com/250/FF0000/FFFFFF/?text=Error'; // Error placeholder
                // Optionally, retry after a delay on error too
                // setTimeout(fetchQRCode, 10000);
            }
        }

        function startCountdown(seconds) {
            clearInterval(countdownInterval); // Clear any existing interval
            let timeLeft = seconds;
            countdownElement.textContent = timeLeft;
            countdownInterval = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                if (timeLeft < 0) { // Changed to < 0 to allow 0 to display briefly
                    clearInterval(countdownInterval);
                    statusMessageElement.textContent = 'QR code expired. Refreshing...';
                    fetchQRCode(); // Fetch a new QR code
                }
            }, 1000);
        }

        // Initial fetch
        fetchQRCode();

        // Optional: Implement WebSocket connection here to listen for scan success from the server
        // and for new QR codes pushed by the server.
        // const socket = new WebSocket('ws://localhost:3000'); // Adjust URL as needed
        // socket.onmessage = function(event) {
        //     const message = JSON.parse(event.data);
        //     if (message.type === 'scanSuccess') {
        //         statusMessageElement.textContent = 'Successfully Paired! Session ID: ' + message.sessionId;
        //         clearInterval(countdownInterval);
        //         // Optionally redirect or show more info
        //     } else if (message.type === 'newQR') {
        //          qrImage.src = message.qrDataUrl;
        //          startCountdown(60);
        //     }
        // };
    </script>
</body>
</html>
